<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dragon White ü§ç</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-white text-gray-900 font-mono p-6">

<!-- CABECERA CON LOGO -->
<div class="flex items-center mb-6 space-x-4">
  <img src="logodragonwhite.png" alt="Logo Dragon White" class="w-16 h-16 rounded-full border border-gray-400">
  <h1 class="text-3xl font-bold">Dragon White ü§ç</h1>
</div>

<!-- HISTORIA -->
<div class="p-4 mb-6 bg-gray-100 border border-gray-300 rounded-lg shadow text-gray-800 whitespace-pre-line">
A quien lea estas l√≠neas, no escribo por perd√≥n ni por gloria,
sino porque nuestra historia no debe quedar en rumores ni en mitos inventados.
Debe estar escrita, aunque sea en la sombra.

Nacimos en los callejones del puerto, donde lo √∫nico que hab√≠a era hambre,
marcados demasiado pronto, cansados de ver
c√≥mo la ciudad nos devoraba sin devolver nada.

El nombre no fue casual: drag√≥n por poder, blanco por la frialdad,
la forma en que aprendimos a movernos en un mundo que no nos quer√≠a vivos.

No √©ramos h√©roes ni monstruos, sino un organismo vivo.
La lealtad era ley, la traici√≥n significaba sentencia inmediata.
Muchos quisieron entrar, pocos soportaron el peso.

Hoy el nombre Dragon White persiste en murales, en susurros y en archivos tachados.
Algunos cayeron, otros se dispersaron, pero la esencia permanece.
Un drag√≥n no muere: se repliega, se esconde y espera su momento.

Y si estas palabras llegan a alguien, que entienda:
no buscan asustar, sino recordar que en la sombra de la ciudad
existi√≥ un drag√≥n blanco que nunca dej√≥ de respirar.
</div>

<!-- CHAT -->
<h2 class="text-2xl font-bold mb-4">üí¨ Chat de la Banda</h2>
<div class="mb-6">
  <div id="chatDragon" class="h-40 overflow-y-auto border border-gray-400 p-2 bg-gray-100 rounded mb-2"></div>
  <input id="msgDragon" type="text" placeholder="Mensaje..." class="w-full p-2 rounded border border-gray-400 bg-gray-200 text-gray-900">
  <button id="sendDragon" class="mt-1 w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white">Enviar</button>
</div>

<!-- LISTADO DE MISIONES -->
<h2 class="text-2xl font-bold mb-4">üìÇ Misiones Asignadas</h2>
<div id="missionsBox" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

<!-- MODAL COMPLETAR -->
<div id="modalCompletar" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center">
  <div class="bg-white p-6 rounded-xl shadow-lg w-96">
    <h3 class="text-xl font-bold mb-4">Completar misi√≥n</h3>
    <input id="pruebaLink" type="text" placeholder="Pega aqu√≠ el link de la prueba..." 
           class="w-full p-2 border border-gray-400 rounded mb-4">
    <div class="flex justify-end space-x-2">
      <button id="cancelarBtn" class="px-3 py-1 bg-gray-500 hover:bg-gray-600 rounded text-white">Cancelar</button>
      <button id="confirmarBtn" class="px-3 py-1 bg-green-600 hover:bg-green-700 rounded text-white">Confirmar</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getDatabase, ref, onChildAdded, push, set, update } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

const { jsPDF } = window.jspdf;

const firebaseConfig = {
  apiKey: "AIzaSyAbbODksHMu7HrhrAP3MlBVzhtMn-8sPJQ",
  authDomain: "bandasibericarp.firebaseapp.com",
  databaseURL: "https://bandasibericarp-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "bandasibericarp",
  storageBucket: "bandasibericarp.firebasestorage.app",
  messagingSenderId: "599477975058",
  appId: "1:599477975058:web:b9faafcd205f27c49240cb",
  measurementId: "G-J8QJ1SNQFB"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// CHAT
const chatDragon = document.getElementById("chatDragon");
const msgDragon = document.getElementById("msgDragon");
const sendDragon = document.getElementById("sendDragon");

function showMessage(container, msg) {
  let div = document.createElement("div");
  div.textContent = msg.sender + ": " + msg.text;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

onChildAdded(ref(db, "chats/Dragon White"), snap => showMessage(chatDragon, snap.val()));

sendDragon.addEventListener("click", () => {
  if (msgDragon.value.trim() === "") return;
  push(ref(db, "chats/Dragon White"), { sender: "Dragon White ü§ç", text: msgDragon.value });
  msgDragon.value = "";
});

// MISI√ìNES
const missionsBox = document.getElementById("missionsBox");

let selectedMission = null;
const modal = document.getElementById("modalCompletar");
const pruebaLink = document.getElementById("pruebaLink");
const cancelarBtn = document.getElementById("cancelarBtn");
const confirmarBtn = document.getElementById("confirmarBtn");

// Abrir modal
function openModal(mission, key) {
  selectedMission = { ...mission, key };
  pruebaLink.value = "";
  modal.classList.remove("hidden");
}
// Cerrar modal
function closeModal() {
  modal.classList.add("hidden");
  selectedMission = null;
}
cancelarBtn.onclick = closeModal;

// Confirmar env√≠o
confirmarBtn.onclick = async () => {
  if (!selectedMission) return;
  const pruebas = pruebaLink.value.trim();
  if (!pruebas) return alert("Debes introducir un link de pruebas.");

  // Enviar embed a Discord
  const webhookURL = "https://discord.com/api/webhooks/1413100905150283777/6h6x-7R24OZ1LR5qbaheZaW1KUxqA-7WJxAVbjPSdLyRNkI_MbNyTNpKNkG-eS66rxlN";
  const embed = {
    title: "üìã Misi√≥n completada (pendiente de confirmaci√≥n)",
    color: 3447003,
    fields: [
      { name: "Banda", value: "Dragon White ü§ç" },
      { name: "T√≠tulo", value: selectedMission.title },
      { name: "Descripci√≥n", value: selectedMission.description },
      { name: "Detalles", value: selectedMission.details },
      { name: "Fecha Impuesta", value: selectedMission.createdAt ? new Date(selectedMission.createdAt).toLocaleString() : "N/A" },
      { name: "Fecha Completada", value: new Date().toLocaleString() },
      { name: "Pruebas", value: pruebas }
    ]
  };

  await fetch(webhookURL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ embeds: [embed] })
  });

  // Marcar en Firebase como "pendiente de confirmaci√≥n"
  await update(ref(db, `missions/Dragon White/${selectedMission.key}`), {
    status: "pendiente",
    prueba: pruebas,
    completedAt: new Date().toISOString()
  });

  closeModal();
};

onChildAdded(ref(db, "missions/Dragon White"), snap => {
  const mission = snap.val();
  const key = snap.key;

  let div = document.createElement("div");
  div.className = "p-4 border border-gray-400 bg-gray-100 rounded-lg shadow flex flex-col justify-between";

  let content = document.createElement("div");
  content.innerHTML = `<b class="text-lg text-gray-900">${mission.title}</b>
                       <p class="text-sm text-gray-600">Banda: Dragon White ü§ç</p>
                       <p class="mt-2 text-gray-800">${mission.description}</p>
                       <p class="mt-2 text-gray-600 italic">${mission.details}</p>
                       <p class="mt-2 text-gray-500">üìÖ Fecha impuesta: ${mission.createdAt ? new Date(mission.createdAt).toLocaleString() : "N/A"}</p>`;

  let btnPDF = document.createElement("button");
  btnPDF.textContent = "üìÑ Ver m√°s";
  btnPDF.className = "px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-white mt-2";
  btnPDF.onclick = () => {
    const doc = new jsPDF();
    doc.setFontSize(16);
    doc.text("Detalles de la misi√≥n", 10, 20);
    doc.setFontSize(12);

    const titleLines = doc.splitTextToSize("T√≠tulo: " + mission.title, 180);
    const bandLines = doc.splitTextToSize("Banda: Dragon White", 180);
    const descLines = doc.splitTextToSize("Descripci√≥n: " + mission.description, 180);
    const detailsLines = doc.splitTextToSize("Detalles: " + mission.details, 180);
    const dateLines = doc.splitTextToSize("Fecha impuesta: " + (mission.createdAt ? new Date(mission.createdAt).toLocaleString() : "N/A"), 180);

    let y = 40;
    [titleLines, bandLines, descLines, detailsLines, dateLines].forEach(lines => {
      doc.text(lines, 10, y);
      y += lines.length * 6;
    });

    doc.save(`${mission.title.replace(/\s+/g, "_")}.pdf`);
  };

  let btnCompletar = document.createElement("button");
  btnCompletar.textContent = "‚úÖ Completar";
  btnCompletar.className = "px-3 py-1 bg-green-600 hover:bg-green-700 rounded text-white mt-2";
  btnCompletar.onclick = () => openModal(mission, key);

  div.appendChild(content);
  div.appendChild(btnPDF);
  div.appendChild(btnCompletar);
  missionsBox.appendChild(div);
});
</script>
</body>
</html>
